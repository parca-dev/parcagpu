# Test container for running test.sh in isolation
FROM debian:bookworm-slim

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /test

# Create directory structure
RUN mkdir -p build/bin build/lib

# Copy the built library
COPY build/lib/libparcagpucupti.so ./build/lib/

# Copy the test files
COPY build/bin/test_cupti_prof ./build/bin/
COPY build/lib/libcuda.so ./build/lib/
COPY build/lib/libcuda.so.1 ./build/lib/
COPY build/lib/libcupti.so ./build/lib/
COPY build/lib/libcupti.so.12 ./build/lib/

# Set environment
ENV LD_LIBRARY_PATH=/test/build/lib
ENV PARCAGPU_DEBUG=1

# Run tests by default
ENTRYPOINT ["/test/build/bin/test_cupti_prof", "/test/build/lib/libparcagpucupti.so"]
CMD []
